<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>座席メーカー</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap');
        
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: #f1f5f9; /* Slate-100 */
        }

        /* 印刷設定 */
        @media print {
            body { background-color: white; }
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            .seat-container { 
                border: 2px solid #000;
                box-shadow: none;
                transform: scale(0.9);
                margin: 0 auto;
                background: white !important;
            }
            .seat {
                border: 1px solid #000 !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            .main-layout { display: block; }
            .control-panel { display: none; }
            .grid-area { width: 100%; justify-content: center; background: white; }
            /* 印刷時はヘッダー非表示 */
            header { display: none; }
        }

        /* 座席の個別スタイル */
        .seat {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            user-select: none;
        }
        .seat:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            z-index: 10;
        }
        .seat.dragging {
            opacity: 0.6;
            transform: scale(0.95);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .seat.drag-over {
            border: 2px dashed #64748b; /* Slate-500 */
            transform: scale(1.02);
        }

        /* 視点回転アニメーション */
        .rotate-180-centered {
            transform: rotate(180deg);
        }
        .rotate-180-centered .seat-content {
            transform: rotate(180deg);
        }

        /* カスタムスクロールバー */
        textarea::-webkit-scrollbar {
            width: 6px;
        }
        textarea::-webkit-scrollbar-track {
            background: #f8fafc; 
        }
        textarea::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 3px;
        }
        textarea::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden text-slate-800">

    <!-- ヘッダー -->
    <header class="bg-slate-800 shadow-md z-10 no-print">
        <div class="max-w-full mx-auto px-6 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-blue-500 text-white p-2 rounded-lg">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-white tracking-wide">座席メーカー</h1>
                    <span class="text-xs text-slate-400 font-medium tracking-wider">CLASSROOM SEATING CHART 6x8</span>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="window.print()" class="bg-slate-700 hover:bg-slate-600 text-slate-200 px-4 py-2 rounded-lg text-sm font-medium transition flex items-center gap-2 border border-slate-600">
                    <i class="fas fa-print"></i> <span class="hidden sm:inline">印刷</span>
                </button>
            </div>
        </div>
    </header>

    <!-- メインコンテンツ -->
    <main class="flex-1 flex overflow-hidden main-layout">
        
        <!-- 左サイドバー（設定・入力） -->
        <aside class="w-80 bg-white border-r border-slate-200 flex flex-col overflow-y-auto no-print control-panel z-20 shadow-lg">
            <div class="p-5 space-y-6">
                
                <!-- 名簿入力エリア -->
                <div class="space-y-4">
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-blue-600 uppercase tracking-wider"><i class="fas fa-mars mr-1"></i> 男子名簿</label>
                            <span class="bg-blue-100 text-blue-800 text-xs px-2 py-0.5 rounded-full font-bold"><span id="boyCount">0</span>名</span>
                        </div>
                        <textarea id="boyNames" class="w-full h-24 p-2 bg-white border border-slate-300 rounded focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm resize-none transition" placeholder="リストを貼り付け..."></textarea>
                    </div>
                    <div class="bg-slate-50 p-3 rounded-lg border border-slate-200">
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-bold text-pink-600 uppercase tracking-wider"><i class="fas fa-venus mr-1"></i> 女子名簿</label>
                            <span class="bg-pink-100 text-pink-800 text-xs px-2 py-0.5 rounded-full font-bold"><span id="girlCount">0</span>名</span>
                        </div>
                        <textarea id="girlNames" class="w-full h-24 p-2 bg-white border border-slate-300 rounded focus:ring-2 focus:ring-pink-500 focus:border-transparent text-sm resize-none transition" placeholder="リストを貼り付け..."></textarea>
                    </div>
                </div>

                <div class="border-t border-slate-100 pt-4">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-3">レイアウト・プリセット</label>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <button onclick="applyPreset('checker')" class="px-3 py-2 bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 rounded text-xs font-medium text-slate-600 transition shadow-sm text-left">
                            <i class="fas fa-chess-board mr-2 text-slate-400"></i>市松模様
                        </button>
                        <button onclick="applyPreset('rows')" class="px-3 py-2 bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 rounded text-xs font-medium text-slate-600 transition shadow-sm text-left">
                            <i class="fas fa-grip-lines-vertical mr-2 text-slate-400"></i>男女列別
                        </button>
                        <button onclick="applyPreset('boys-front')" class="px-3 py-2 bg-white border border-slate-200 hover:bg-slate-50 hover:border-slate-300 rounded text-xs font-medium text-slate-600 transition shadow-sm text-left">
                            <i class="fas fa-arrow-up mr-2 text-slate-400"></i>男子前方
                        </button>
                        <button onclick="applyPreset('reset')" class="px-3 py-2 bg-white border border-red-100 hover:bg-red-50 hover:border-red-200 rounded text-xs font-medium text-red-600 transition shadow-sm text-left">
                            <i class="fas fa-eraser mr-2 text-red-300"></i>全クリア
                        </button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2 text-center">※ 座席クリックで属性切替 (フリー/男/女/不可)</p>
                </div>

                <div class="border-t border-slate-100 pt-4 space-y-3">
                    <button onclick="shuffleSeats()" class="w-full bg-slate-800 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg shadow-lg shadow-slate-300/50 transition transform hover:-translate-y-0.5 flex justify-center items-center gap-2">
                        <i class="fas fa-bolt text-yellow-400"></i> 席決めスタート
                    </button>
                    <button onclick="clearNamesOnly()" class="w-full bg-white border border-slate-300 hover:bg-slate-50 text-slate-600 font-medium py-2 px-4 rounded-lg transition text-sm">
                        名前のみクリア
                    </button>
                </div>
            </div>
        </aside>

        <!-- 右エリア（座席グリッド） -->
        <div class="flex-1 bg-slate-100 overflow-auto p-4 md:p-8 flex flex-col items-center grid-area relative">
            
            <!-- ビュー切り替えコントロール -->
            <div class="mb-8 flex items-center gap-4 bg-white p-1.5 rounded-full shadow-sm border border-slate-200 no-print z-10">
                <span id="viewLabel" class="text-xs font-bold px-4 py-1.5 bg-slate-100 rounded-full text-slate-600 uppercase tracking-wide">
                    <i class="fas fa-users mr-1"></i> 生徒視点
                </span>
                <button onclick="toggleView()" class="text-slate-500 hover:text-slate-800 hover:bg-slate-100 transition w-8 h-8 rounded-full flex items-center justify-center" title="視点を180度回転">
                    <i class="fas fa-sync-alt"></i>
                </button>
            </div>

            <!-- 黒板エリア -->
            <div id="blackboard" class="w-3/4 max-w-3xl h-10 bg-[#2d4035] rounded shadow-md flex items-center justify-center mb-8 text-white/80 text-sm font-bold tracking-[1em] border-b-4 border-[#3e2723]/60 relative overflow-hidden">
                <div class="absolute inset-0 bg-gradient-to-b from-white/5 to-transparent pointer-events-none"></div>
                黒　板
            </div>

            <!-- 座席コンテナ -->
            <div id="seatContainer" class="seat-container bg-white p-8 rounded-2xl shadow-xl shadow-slate-200/50 transition-transform duration-500 ease-in-out border border-slate-100">
                <div class="grid grid-cols-6 gap-3" id="seatGrid">
                    <!-- JSで生成されます -->
                </div>
            </div>

            <!-- 印刷用フッター -->
            <div class="hidden print-only mt-12 w-full text-center">
                <div class="border-t border-slate-300 pt-4 flex justify-between px-24 text-slate-600 text-sm">
                    <div>日付: <span class="inline-block w-12 border-b border-slate-400"></span>月 <span class="inline-block w-12 border-b border-slate-400"></span>日</div>
                    <div>担任: <span class="inline-block w-24 border-b border-slate-400"></span></div>
                </div>
            </div>

        </div>
    </main>

    <!-- モーダル（名前入力用） -->
    <div id="nameModal" class="fixed inset-0 bg-slate-900/50 backdrop-blur-sm hidden items-center justify-center z-50 transition-opacity">
        <div class="bg-white rounded-xl p-6 w-80 shadow-2xl transform transition-all border border-slate-100">
            <h3 class="text-lg font-bold mb-4 text-slate-800 flex items-center gap-2">
                <i class="fas fa-user-edit text-slate-400"></i> 座席編集
            </h3>
            <input type="text" id="modalInputName" class="w-full bg-slate-50 border border-slate-300 rounded-lg p-3 mb-6 text-lg focus:ring-2 focus:ring-blue-500 focus:outline-none transition" placeholder="名前を入力">
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm font-medium transition">キャンセル</button>
                <button onclick="saveModal()" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 text-sm font-bold shadow-lg shadow-slate-300/50 transition">確定</button>
            </div>
        </div>
    </div>

    <script>
        // 設定定数
        const COLS = 6;
        const ROWS = 8;
        const TOTAL_SEATS = COLS * ROWS;
        let isTeacherView = false;
        let currentEditSeatIndex = -1;

        // 座席データ管理
        let seatsData = [];

        // DOM要素
        const gridEl = document.getElementById('seatGrid');
        const containerEl = document.getElementById('seatContainer');
        const viewLabelEl = document.getElementById('viewLabel');
        const boyInput = document.getElementById('boyNames');
        const girlInput = document.getElementById('girlNames');
        const boyCountEl = document.getElementById('boyCount');
        const girlCountEl = document.getElementById('girlCount');

        // 初期化
        function init() {
            for (let i = 0; i < TOTAL_SEATS; i++) {
                seatsData.push({
                    id: i,
                    type: 'any',
                    name: '',
                    locked: false
                });
            }
            renderGrid();
            updateCounts();
        }

        // 人数カウント更新
        function updateCounts() {
            const b = boyInput.value.trim().split(/\n/).filter(line => line.trim() !== '').length;
            const g = girlInput.value.trim().split(/\n/).filter(line => line.trim() !== '').length;
            boyCountEl.textContent = b;
            girlCountEl.textContent = g;
        }
        boyInput.addEventListener('input', updateCounts);
        girlInput.addEventListener('input', updateCounts);

        // グリッド描画
        function renderGrid() {
            gridEl.innerHTML = '';

            seatsData.forEach((seat, index) => {
                const seatEl = document.createElement('div');
                
                // クラス設定 - クールなデザインに変更
                let colorClass = 'bg-slate-50 border-slate-200 text-slate-400';
                let icon = '';
                
                if (seat.type === 'boy') {
                    colorClass = 'bg-blue-50/50 border-blue-200 text-blue-600';
                    icon = '<i class="fas fa-mars text-blue-100 absolute bottom-1 right-2 text-3xl opacity-50 pointer-events-none"></i>';
                } else if (seat.type === 'girl') {
                    colorClass = 'bg-pink-50/50 border-pink-200 text-pink-600';
                    icon = '<i class="fas fa-venus text-pink-100 absolute bottom-1 right-2 text-3xl opacity-50 pointer-events-none"></i>';
                } else if (seat.type === 'unused') {
                    colorClass = 'bg-slate-100 border-slate-200 opacity-40'; // より控えめに
                }

                if (seat.locked) {
                    // ロック時はアクセントを強める
                    colorClass += ' ring-2 ring-yellow-400/70 ring-offset-2 ring-offset-white';
                }

                seatEl.className = `seat relative w-20 h-20 md:w-24 md:h-24 rounded-lg border-2 flex flex-col items-center justify-center cursor-pointer shadow-sm ${colorClass}`;
                
                seatEl.setAttribute('draggable', seat.type !== 'unused');
                seatEl.dataset.index = index;

                // コンテンツ生成
                if (seat.type !== 'unused') {
                    // 名前がある場合は濃い色、なければ薄い番号
                    const textColor = seat.name ? 'text-slate-800' : 'text-slate-300';
                    const nameDisplay = seat.name 
                        ? `<span class="text-lg font-bold ${textColor} z-10 break-all leading-tight text-center px-1 drop-shadow-sm">${seat.name}</span>` 
                        : `<span class="${textColor} font-bold text-xl z-10 font-mono opacity-50">${index + 1}</span>`;
                    
                    const lockIcon = seat.locked 
                        ? `<button onclick="toggleLock(event, ${index})" class="absolute top-1 right-1 text-yellow-500 hover:text-yellow-600 transition z-20 drop-shadow-sm"><i class="fas fa-lock"></i></button>`
                        : `<button onclick="toggleLock(event, ${index})" class="absolute top-1 right-1 text-slate-300 hover:text-slate-400 transition z-20"><i class="fas fa-lock-open text-xs"></i></button>`;

                    const contentWrapper = `<div class="seat-content w-full h-full flex items-center justify-center relative overflow-hidden rounded-lg">${nameDisplay}${lockIcon}${icon}</div>`;
                    
                    seatEl.innerHTML = contentWrapper;
                } else {
                    seatEl.innerHTML = '<i class="fas fa-times text-slate-300 text-lg"></i>';
                }

                seatEl.addEventListener('click', (e) => handleSeatClick(e, index));
                seatEl.addEventListener('dblclick', (e) => openModal(index));
                
                if (seat.type !== 'unused') {
                    seatEl.addEventListener('dragstart', handleDragStart);
                    seatEl.addEventListener('dragenter', handleDragEnter);
                    seatEl.addEventListener('dragover', handleDragOver);
                    seatEl.addEventListener('dragleave', handleDragLeave);
                    seatEl.addEventListener('drop', handleDrop);
                    seatEl.addEventListener('dragend', handleDragEnd);
                }

                gridEl.appendChild(seatEl);
            });
        }

        function handleSeatClick(e, index) {
            if (e.target.closest('button')) return;

            const seat = seatsData[index];
            if (seat.locked) return;

            const types = ['any', 'boy', 'girl', 'unused'];
            const currentIdx = types.indexOf(seat.type);
            seat.type = types[(currentIdx + 1) % types.length];
            
            if (seat.type === 'unused') {
                seat.name = '';
            }
            renderGrid();
        }

        function toggleLock(e, index) {
            e.stopPropagation();
            seatsData[index].locked = !seatsData[index].locked;
            renderGrid();
        }

        function openModal(index) {
            if (seatsData[index].type === 'unused') return;
            currentEditSeatIndex = index;
            document.getElementById('modalInputName').value = seatsData[index].name;
            const modal = document.getElementById('nameModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            // アニメーション用クラス操作
            setTimeout(() => {
                modal.firstElementChild.classList.remove('scale-95', 'opacity-0');
                modal.firstElementChild.classList.add('scale-100', 'opacity-100');
            }, 10);
            document.getElementById('modalInputName').focus();
        }

        function closeModal() {
            const modal = document.getElementById('nameModal');
            // アニメーション
            modal.firstElementChild.classList.remove('scale-100', 'opacity-100');
            modal.firstElementChild.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 200);
            currentEditSeatIndex = -1;
        }

        function saveModal() {
            if (currentEditSeatIndex === -1) return;
            const newName = document.getElementById('modalInputName').value.trim();
            seatsData[currentEditSeatIndex].name = newName;
            
            if (newName !== "") {
                seatsData[currentEditSeatIndex].locked = true;
            }

            renderGrid();
            closeModal();
        }

        // --- 席決めアルゴリズム ---
        function shuffleSeats() {
            let boys = boyInput.value.split(/\n/).map(s => s.trim()).filter(s => s !== "");
            let girls = girlInput.value.split(/\n/).map(s => s.trim()).filter(s => s !== "");

            const shuffle = (arr) => {
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };

            boys = shuffle(boys);
            girls = shuffle(girls);

            seatsData.forEach(s => {
                if (!s.locked && s.type !== 'unused') s.name = '';
            });

            let boySeats = [];
            let girlSeats = [];
            let anySeats = [];

            seatsData.forEach(s => {
                if (s.locked || s.type === 'unused') return;
                if (s.type === 'boy') boySeats.push(s);
                else if (s.type === 'girl') girlSeats.push(s);
                else anySeats.push(s);
            });

            boySeats.forEach(s => { if (boys.length) s.name = boys.pop(); });
            girlSeats.forEach(s => { if (girls.length) s.name = girls.pop(); });

            let remainingPeople = [...boys, ...girls];
            remainingPeople = shuffle(remainingPeople);

            anySeats.forEach(s => { if (remainingPeople.length) s.name = remainingPeople.pop(); });

            if (remainingPeople.length > 0) {
                const emptyRest = seatsData.filter(s => !s.locked && s.type !== 'unused' && s.name === '');
                emptyRest.forEach(s => { if (remainingPeople.length) s.name = remainingPeople.pop(); });
            }

            renderGrid();

            if (remainingPeople.length > 0) {
                alert(`席が足りず、以下の生徒を配置できませんでした：\n${remainingPeople.join(', ')}`);
            }
        }

        function clearNamesOnly() {
            if(!confirm('ロックされていない席の名前を全て消去しますか？')) return;
            seatsData.forEach(s => {
                if (!s.locked) s.name = '';
            });
            renderGrid();
        }

        function applyPreset(mode) {
            seatsData.forEach((s, i) => {
                if (s.locked) return;

                const row = Math.floor(i / COLS);
                const col = i % COLS;

                if (mode === 'reset') {
                    s.type = 'any';
                } else if (mode === 'checker') {
                    s.type = ((row + col) % 2 === 0) ? 'boy' : 'girl';
                } else if (mode === 'rows') {
                    s.type = (col % 2 === 0) ? 'boy' : 'girl';
                } else if (mode === 'boys-front') {
                    s.type = (row < ROWS / 2) ? 'boy' : 'girl';
                }
            });
            renderGrid();
        }

        function toggleView() {
            isTeacherView = !isTeacherView;
            if (isTeacherView) {
                containerEl.classList.add('rotate-180-centered');
                viewLabelEl.innerHTML = '<i class="fas fa-chalkboard-teacher mr-1"></i> 教卓視点';
                viewLabelEl.className = "text-xs font-bold px-4 py-1.5 bg-amber-100 rounded-full text-amber-800 uppercase tracking-wide";
            } else {
                containerEl.classList.remove('rotate-180-centered');
                viewLabelEl.innerHTML = '<i class="fas fa-users mr-1"></i> 生徒視点';
                viewLabelEl.className = "text-xs font-bold px-4 py-1.5 bg-slate-100 rounded-full text-slate-600 uppercase tracking-wide";
            }
        }

        // --- DnD ロジック ---
        let dragSrcIndex = -1;

        function handleDragStart(e) {
            this.classList.add('dragging');
            dragSrcIndex = parseInt(this.dataset.index);
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
        }

        function handleDragOver(e) {
            if (e.preventDefault) e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnter(e) {
            if (this.dataset.index != dragSrcIndex) {
                this.classList.add('drag-over');
            }
        }

        function handleDragLeave(e) {
            this.classList.remove('drag-over');
        }

        function handleDrop(e) {
            if (e.stopPropagation) e.stopPropagation();
            
            const targetIndex = parseInt(this.dataset.index);
            
            if (dragSrcIndex !== targetIndex && seatsData[targetIndex].type !== 'unused') {
                const srcData = seatsData[dragSrcIndex];
                const targetData = seatsData[targetIndex];

                const tempName = srcData.name;
                const tempLocked = srcData.locked;

                srcData.name = targetData.name;
                srcData.locked = targetData.locked;

                targetData.name = tempName;
                targetData.locked = tempLocked;

                renderGrid();
            }
            return false;
        }

        function handleDragEnd(e) {
            this.classList.remove('dragging');
            document.querySelectorAll('.seat').forEach(el => el.classList.remove('drag-over'));
        }

        // 開始
        init();

    </script>
</body>
</html>
